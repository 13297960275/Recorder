/*
录音，RecordSDK：无限兼容任何浏览器的全功能录音解决方案
https://github.com/xiangyuecn/Recorder
src: recorder-core.js,../asset-record-sdk/record-sdk/src/record-web-sdk.js
*/
!function(p){"use strict";var v=function(){},O=function(e){return new t(e)};O.IsOpen=function(){var e=O.Stream;if(e){var t=e.getTracks&&e.getTracks()||e.audioTracks||[],n=t[0];if(n){var r=n.readyState;return"live"==r||r==n.LIVE}}return!1},O.BufferSize=4096,O.Destroy=function(){for(var e in console.log("Recorder Destroy"),n)n[e]()};var n={};O.BindDestroy=function(e,t){n[e]=t},O.Support=function(){var e=p.AudioContext;if(e||(e=p.webkitAudioContext),!e)return!1;var t=navigator.mediaDevices||{};return t.getUserMedia||(t=navigator).getUserMedia||(t.getUserMedia=t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia),!!t.getUserMedia&&(O.Scope=t,O.Ctx&&"closed"!=O.Ctx.state||(O.Ctx=new e,O.BindDestroy("Ctx",function(){var e=O.Ctx;e&&e.close&&e.close()})),!0)},O.SampleData=function(e,t,n,r,a){r||(r={});var o=r.index||0,i=r.offset||0,s=r.frameNext||[];a||(a={});var c=a.frameSize||1;a.frameType&&(c="mp3"==a.frameType?1152:1);for(var f=0,l=o;l<e.length;l++)f+=e[l].length;f=Math.max(0,f-Math.floor(i));var u=t/n;1<u?f=Math.floor(f/u):(u=1,n=t),f+=s.length;for(var p=new Int16Array(f),v=0,l=0;l<s.length;l++)p[v]=s[l],v++;for(var m=e.length;o<m;o++){for(var d=e[o],l=i,h=d.length;l<h;){var g=Math.floor(l),S=Math.ceil(l),_=l-g;p[v]=d[g]+(d[S]-d[g])*_,v++,l+=u}i=l-h}s=null;var y=p.length%c;if(0<y){var M=2*(p.length-y);s=new Int16Array(p.buffer.slice(M)),p=new Int16Array(p.buffer.slice(0,M))}return{index:o,offset:i,frameNext:s,sampleRate:n,data:p}},O.PowerLevel=function(e,t){var n=e/t||0;return n<1251?Math.round(n/1250*10):Math.round(Math.min(100,Math.max(0,100*(1+Math.log(n/1e4)/Math.log(10)))))};var r=0;function t(e){this.id=++r,O.Traffic&&O.Traffic();var t={type:"mp3",bitRate:16,sampleRate:16e3,onProcess:v};for(var n in e)t[n]=e[n];this.set=t,this._S=9}O.Sync={O:9,C:9},O.prototype=t.prototype={open:function(e,n){var t=this;e=e||v,n=n||v;var r=function(){e(),t._SO=0},a=function(e,t){/Permission|Allow/i.test(e)?n("用户拒绝了录音权限",!0):!1===p.isSecureContext?n("无权录音(需https)"):/Found/i.test(e)?n(t+"，无可用麦克风"):n(t)},o=O.Sync,i=++o.O,s=o.C;t._O=t._O_=i,t._SO=t._S;var c=function(){if(s!=o.C||!t._O){var e="open被取消";return i==o.O?t.close():e="open被中断",n(e),!0}};if(O.IsOpen())r();else if(O.Support()){var f=function(e){(O.Stream=e)._call={},c()||setTimeout(function(){c()||(O.IsOpen()?(function(){var e=O.Ctx,t=O.Stream,n=t._m=e.createMediaStreamSource(t),r=t._p=(e.createScriptProcessor||e.createJavaScriptNode).call(e,O.BufferSize,1,1);n.connect(r),r.connect(e.destination);var f=t._call;r.onaudioprocess=function(e){for(var t in f){for(var n=e.inputBuffer.getChannelData(0),r=n.length,a=new Int16Array(r),o=0,i=0;i<r;i++){var s=Math.max(-1,Math.min(1,n[i]));s=s<0?32768*s:32767*s,a[i]=s,o+=Math.abs(s)}for(var c in f)f[c](a,o);return}}}(),r()):n("录音功能无效：无音频流"))},100)},l=function(e){var t=e.name||e.message||e.code+":"+e;console.error(e),a(t,"无法录音："+t)},u=O.Scope.getUserMedia({audio:!0},f,l);u&&u.then&&u.then(f)[e&&"catch"](l)}else a("","此浏览器不支持录音")},close:function(e){e=e||v,this._stop();var t=O.Sync;if(this._O=0,this._O_!=t.O)return console.warn("close被忽略"),void e();t.C++;var n,r=O.Stream;if(r){(n=O.Stream)._m&&(n._m.disconnect(),n._p.disconnect(),n._p.onaudioprocess=n._p=n._m=null);for(var a=r.getTracks&&r.getTracks()||r.audioTracks||[],o=0;o<a.length;o++){var i=a[o];i.stop&&i.stop()}r.stop&&r.stop()}O.Stream=0,e()},mock:function(e,t){var n=this;return n._stop(),n.isMock=1,n.buffers=[e],n.recSize=e.length,n.srcSampleRate=t,n},envStart:function(e,t){var n=this,r=n.set;if(n.isMock=e?1:0,n.buffers=[],n.recSize=0,n.envInLast=0,n.envInFirst=0,n.envInFix=0,n.envInFixTs=[],r.sampleRate=Math.min(t,r.sampleRate),n.srcSampleRate=t,n.engineCtx=0,n[r.type+"_start"]){var a=n.engineCtx=n[r.type+"_start"](r);a&&(a.pcmDatas=[],a.pcmSize=0)}},envResume:function(){this.envInFixTs=[]},envIn:function(e,t){var a=this,o=a.set,i=a.engineCtx,n=a.srcSampleRate,r=e.length,s=O.PowerLevel(t,r),c=a.buffers,f=c.length;c.push(e);var l=Date.now(),u=Math.round(r/n*1e3);a.envInLast=l,1==a.buffers.length&&(a.envInFirst=l-u);var p=a.envInFixTs;p.splice(0,0,{t:l,d:u});for(var v=l,m=0,d=0;d<p.length;d++){var h=p[d];if(3e3<l-h.t){p.length=d;break}v=h.t,m+=h.d}var g=p[1],S=l-v;if(S/3<S-m&&(g&&1e3<S||6<=p.length)){var _=l-g.t-u;if(u/5<_){var y=!o.disableEnvInFix;if(console.warn("["+l+"]"+(y?"":"未")+"补偿"+_+"ms"),a.envInFix+=_,y){var M=new Int16Array(_*n/1e3);r+=M.length,c.push(M)}}}var x=a.recSize,I=r,R=x+I;if(a.recSize=R,i){var w=O.SampleData(c,n,o.sampleRate,i.chunkInfo);i.chunkInfo=w,R=(x=i.pcmSize)+(I=w.data.length),i.pcmSize=R,c=i.pcmDatas,f=c.length,c.push(w.data),n=w.sampleRate}var D=Math.round(R/n*1e3),C=c.length,b=function(){for(var e=T?0:-I,t=0,n=f;n<C;n++){var r=c[n];null==r?t=1:(e+=r.length,i&&r.length&&a[o.type+"_encode"](i,r))}t||(i?i.pcmSize+=e:a.recSize+=e)},T=o.onProcess(c,s,D,n,f,b);if(!0===T){var z=0;for(d=f;d<C;d++)null==c[d]?z=1:c[d]=new Int16Array(0);z?console.warn("异步模式下不能清除buffers"):i?i.pcmSize-=I:a.recSize-=I}else b()},start:function(){if(O.IsOpen()){console.log("["+Date.now()+"]Start");var e=this,t=(e.set,O.Ctx);if(e._stop(),e.state=0,e.envStart(0,t.sampleRate),e._SO&&e._SO+1!=e._S)console.warn("start被中断");else{e._SO=0;var n=function(){e.state=1,e.resume()};"suspended"==t.state?t.resume().then(function(){console.log("ctx resume"),n()}):n()}}else console.error("未open")},pause:function(){this.state&&(this.state=2,delete O.Stream._call[this.id])},resume:function(){var n=this;n.state&&(n.state=1,n.envResume(),O.Stream._call[n.id]=function(e,t){1==n.state&&n.envIn(e,t)})},_stop:function(e){var t=this,n=t.set;t.isMock||t._S++,t.state&&(t.pause(),t.state=0),!e&&t[n.type+"_stop"]&&(t[n.type+"_stop"](t.engineCtx),t.engineCtx=0)},stop:function(n,t,e){var r,a=this,o=a.set;console.log("["+Date.now()+"]Stop "+(a.envInLast?a.envInLast-a.envInFirst+"ms 补"+a.envInFix+"ms":"-"));var i=function(){a._stop(),e&&a.close()},s=function(e){t&&t(e),i()},c=function(e,t){console.log("["+Date.now()+"]结束 编码"+(Date.now()-r)+"ms 音频"+t+"ms/"+e.size+"b"),e.size<Math.max(100,t/2)?s("生成的"+o.type+"无效"):(n&&n(e,t),i())};if(!a.isMock){if(!a.state)return void s("未开始录音");a._stop(!0)}var f=a.recSize;if(f)if(a.buffers[0])if(a[o.type]){var l=a.engineCtx;if(a[o.type+"_complete"]&&l){l.pcmDatas;var u=Math.round(l.pcmSize/o.sampleRate*1e3);return r=Date.now(),void a[o.type+"_complete"](l,function(e){c(e,u)},s)}r=Date.now();var p=O.SampleData(a.buffers,a.srcSampleRate,o.sampleRate);o.sampleRate=p.sampleRate;var v=p.data;u=Math.round(v.length/o.sampleRate*1e3),console.log("采样"+f+"->"+v.length+" 花:"+(Date.now()-r)+"ms"),setTimeout(function(){r=Date.now(),a[o.type](v,function(e){c(e,u)},function(e){s(e)})})}else s("未加载"+o.type+"编码器");else s("音频被释放");else s("未采集到录音")}},p.Recorder&&p.Recorder.Destroy(),(p.Recorder=O).LM="2020-1-8 10:53:14",O.TrafficImgUrl="//ia.51.la/go1?id=20469973&pvFlag=1",O.Traffic=function(){var e=O.TrafficImgUrl;if(e){var t=O.Traffic,n=location.href.replace(/#.*/,"");if(!t[n]){t[n]=1;var r=new Image;r.src=e,console.log("Traffic Analysis Image: Recorder.TrafficImgUrl="+e)}}}}(window),"function"==typeof define&&define.amd&&define(function(){return Recorder}),"object"==typeof module&&module.exports&&(module.exports=Recorder),function(e){"use strict";var t={LM:"2020-4-19 10:41:03",ConfigSet:{}},i=function(){},n=navigator.userAgent;/\bMSIE\b/i.test(n),/MicroMessenger/i.test(n),t.Config=function(e,t,n){var r=this.ConfigSet,a={onResult:i};for(var o in r)a[o]=r[o];for(var o in e)a[o]=e[o];this.ConfigSet=a},t.Record=function(e){var t={type:"mp3",bitRate:16,sampleRate:16e3,runtime:"default",runtimeSet:{processOnly:!1,args:{},customID:""}};for(var n in e)t[n]=e[n];e=t},e.RecordSDK=t}(window),"function"==typeof define&&define.amd&&define(function(){return RecordSDK}),"object"==typeof module&&module.exports&&(module.exports=RecordSDK);